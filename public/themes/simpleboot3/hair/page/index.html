<include file="hair@public/head"/>
<link rel="stylesheet" href="__PAGE_TOOLS__/css/minicolor.css">
<link rel="stylesheet" href="__PAGE_TOOLS__/css/main.css">
<script src="__PAGE_TOOLS__/js/flexible.js"></script>

<form id="page_info">
    <input type="hidden" name="id" value="{$page.id}"/>
    <input type="hidden" name="user_id" value="{$page.user_id}"/>
    <input type="hidden" name="project_id" value="{$page.project_id}"/>
    <input type="hidden" name="name" value="{$page.name}"/>
    <input type="hidden" name="image" value=""/>
</form>
<div class="wrap">
    <div class="tab">
        <ul>
            <li class="fl"><a href="{:url('hair/project/detail',['id'=>$page.project_id])}">返回</a></li>
            <li class="fl tri-head">头像</li>
            <li class="fl tri-fun">工具</li>
            <li class="fl tri-tool">功能</li>
            <li class="fl tri-word">文字</li>
            <li class="fl">分享</li>
        </ul>
    </div>
    <div class="main-wrap">
        <div class="canvas-wrap" style="position: relative;">
            <!-- 背景图片 -->
            <img src="{$page.avatar_url}" alt="" id="bg-img" style="position: absolute;width:100%;height: 100%;opacity: 0;z-index: -2;">

            <div class="c-inner" style="z-index: 9;">
        
                <canvas id="canvas-grids"></canvas>
            </div>
            <div class="c-inner" style="z-index: 10;">
        
                <canvas id="canvas-bg"></canvas>
            </div>
            <div class="c-inner" style="z-index: 11;">
        
                <canvas id="canvas"></canvas>
            </div>
        </div>
        <div class="m-tool m-all-tool">
            <div class="m-inner">
                <ul>
                    <!-- <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            <p class="h-text">发片</p>
                        </div>
                    </li> -->
                    <li class="h-icon fl" renderType='Line'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">直线</p>
                        </div>
                    </li>
                    <li class="h-icon fl" renderType='renderArrow'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">箭头</p>
                        </div>
                    </li>
                    <!-- <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            <p class="h-text">弧线</p>
                        </div>
                    </li> -->
                    <!-- <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            <p class="h-text">虚弧线</p>
                        </div>
                    </li> -->
                    <li class="h-icon fl" renderType='renderTriangle'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">三角形</p>
                        </div>
                    </li>
                    <li class="h-icon fl" renderType='renderCircle'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">圆形</p>
                        </div>
                    </li>
                    <li class="h-icon fl" renderType='renderEllipse'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">椭圆</p>
                        </div>
                    </li>
                    <li class="h-icon fl" renderType='isDrawingMode'>
                        <div class="h-one">
                            <div class="h-img-wrap">
                                <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                            </div>
                            <p class="h-text">画笔</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="m-head m-all-tool">
            <div class="m-inner">
                <ul>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_0.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_1.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_2.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_3.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_4.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_5.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_6.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_7.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/bg_8.png" alt="">
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="m-fun m-all-tool">
            <div class="m-inner">
                <ul>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/tool1.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/tool2.png" alt="">
                        </div>
                    </li>
                    <li class="h-icon fl">
                        <div class="h-one">
                            <img src="__PAGE_TOOLS__/images/tool4.png" alt="">
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mask" id="select-cx">
        <div class="m-box">
            <ul>
                <!-- <li  >
                    <p class="text-c">发片</p>
                    <p>
                        请选择颜色: <input type="color" name='fill'>
                    </p>
                </li> -->
                <li>
                    <p class="text-c">直线</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='stroke fill'></p>
                    <p>线宽：<select class="s-select" key='strokeWidth' id="">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    </p>
                </li>
                <li>
                    <p class="text-c">箭头</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='stroke fill'></p>
                </li>
                <!-- <li>弧线</li> -->
                <!-- <li>虚弧线</li> -->
                <li>
                    <p class="text-c">三角形</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='fill'></p>
                </li>
                <li>
                    <p class="text-c">圆形</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='fill'></p>
                </li>
                <li>
                    <p class="text-c">椭圆</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='fill'></p>
                </li>
                <li>
                    <p class="text-c">画笔</p>
                    <p>颜色：<input class="s-select color" type="hidden" key='color'></p>
                    <p>线宽：<select class="s-select " key='width' id="">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                    </p>
                </li>
            </ul>
            <div class="btn-wrap">
                <div class="btn-no">取消</div>
                <div class="btn-ok">确定</div>
            </div>
        </div>
    </div>
    <div class="mask" id="text">
        <div class="m-box">
            <div class="text-wrap">
                <p>文案：<input type="text" id="i-text"></p>
                <p>颜色：<input class="text-option color" type="hidden" key='stroke fill' name='color'></p>
                <p>粗细：<select class="text-option" key='fontWeight' id="text-width">
                    <option value="normal">正常</option>
                    <option value="bold">加粗</option>
                </select>
                </p>
                <p>字体：<select class="text-option" key='fontSize' name="" id="font-size">
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                </select>
                </p>
            </div>
            <div class="btn-wrap">
                <div class="btn-no">取消</div>
                <div class="btn-ok">确定</div>
            </div>
        </div>
    </div>
    <div class="footer-btn">
        <!-- <div class="btn-pre btn fl">上一步</div> -->
        <div class="btn-delete btn fl">删除</div>
        <div class="btn-save fr btn">生成图片</div>
        <div class="btn-hb btn fr">移除画笔</div>
    </div>
</div>
<div class="mask" id="createImg">
    <div class="m-box text-c">图片生成中...</div>
</div>
<div id="canvas" style="height:200px;"></div>
<!-- <canvas id="canvas"></canvas> -->
<include file="hair@public/foot"/>

<!--<script src="__PAGE_TOOLS__/js/jquery.min.js"></script>-->
<!-- <script src="js/fabric.min.js"></script> -->
<!-- <script src="js/fabric2.js"></script> -->
<script src="__PAGE_TOOLS__/js/jquery.minicolor.js"></script>
<script src="__PAGE_TOOLS__/js/fabric_gestures.js"></script>
<!-- <script src="js/canvas.js"></script> -->
<script>
    $(function () {
        window.obj = {
            init         : function () {
                var _this         = this;
                this.offsetX      = $('.main-wrap').offset().left;
                this.offsetY      = $('.main-wrap').offset().top;
                this.renderOBJ    = null;
                this.renderOption = null;
                this.canvas       = $('#canvas');
                this.canvas_bg    = $('#canvas-bg');
                this.bg_ctx = this.canvas_bg[0].getContext('2d');
                this.setHeight();
                this.grids             = new fabric.Canvas('canvas-grids');
                this.ctx               = new fabric.Canvas('canvas');
                this.ctx.isDrawingMode = false;
                this.baseSize          = this.w / 5;
                this.renderBGImg();
                this.initColor();
                this.bindEvent();
                this.renderBG();
                // setTimeout(function(){
                //     _this.ctx.isDrawingMode =false;
                // },3000);
            },
            bindEvent    : function () {
                var _this = this;
                //工具头像切换
                $('.tri-head').on('click', function () {
                    $('.m-head').slideToggle();
                    $('.m-tool').hide();
                    $('.m-fun').hide();

                });
                $('.tri-tool').on('click', function () {
                    $('.m-tool').slideToggle();
                    $('.m-head').hide();
                    $('.m-fun').hide();
                });
                $('.tri-fun').on('click', function () {
                    $('.m-fun').slideToggle();
                    $('.m-head').hide();
                    $('.m-tool').hide();
                });
                //头像点击
                $('.m-head .h-one,.m-fun .h-one').on('click', function () {
                    var src = $(this).find('img').attr('src');
                    var img = $(this).find('img')[0];
                    // var img = new Image();
                    // img.src=src;
                    // img.width=_this.w/2;
                    // img.height=_this.h/2;
                    var top  = (_this.h - img.height) * 0.6;
                    var left = (_this.w - img.width) / 2;
                    var img  = new fabric.Image(img, {
                        left : left,
                        top  : top,
                    });
                    // img.on('dbclick',function(){
                    //    alert(1111);
                    // });
                    _this.ctx.add(img);
                    $(this).parents('.m-all-tool').slideUp();
                });
                //工具点击
                $('.m-tool li.h-icon').on('click', function () {
                    var index       = $(this).index();
                    _this.renderOBJ = $(this).attr('renderType');
                    $('#select-cx').show().find('li').eq(index).addClass('on').siblings().removeClass('on');
                });
                $('#select-cx .btn-wrap .btn-ok').on("click", function () {
                    var obj       = {};
                    var hasOption = false;
                    var option    = $('#select-cx ul li.on').find('.s-select');
                    option        = _this.createOption(option);
                    console.log(JSON.stringify(option));
                    console.log(_this.renderOBJ);
                    _this.renderFN[_this.renderOBJ].call(_this, option);
                    $('#select-cx').hide();
                    $('.m-tool').hide();
                });
                $('.btn-wrap .btn-no').on("click", function () {
                    $('#select-cx input').val('');
                    $(this).parents('.mask').hide();
                    _this.renderOBJ    = null;
                    _this.renderOption = null;
                });
                //文案点击
                $('.tri-word').on('click', function () {
                    $('.m-all-tool').hide();
                    $('#text').show();
                });
                $('#text .btn-ok').on('click', function () {
                    var text = $('#i-text').val();
                    if (text == '') {
                        alert('文案不能为空~');
                        return false;
                    }
                    var input_option = $('#text').find('.text-option');
                    var option       = _this.createOption(input_option);
                    console.log(JSON.stringify(option));
                    option.left      = _this.w / 2;
                    option.top       = _this.h / 2;
                    option.textAlign = 'center';
                    // option.originY='top';
                    _this.renderOBJ  = 'Text';
                    var text_obj     = new fabric[_this.renderOBJ](text, option);
                    _this.ctx.add(text_obj);
                    $(this).parents('.mask').hide();
                    $('#i-text').val('');
                    $('.m-all-tool').hide();
                    _this.renderOBJ    = null;
                    _this.renderOption = null;

                });
                //
                //
                //
                $('.btn-hb').on('click', function () {

                    $(this).hide();
                    _this.ctx.isDrawingMode = false;
                });

                ///生成图片
                $('.btn-save').on('click', function () {
                    var png = _this.ctx.toDataURL();
                    $('#createImg').show();
                    $("#page_info input[name='image']").val(png);
                    var form = $('#page_info');
                    $.post("{:url('hair/page/doSavePage')}", form.serializeArray(), function (ret) {
                        $('#createImg').hide();
                        if (ret.code) {
                            $.toast(ret.msg, 'success', function () {
                                // window.location.href = ret.data.from_url;
                                // var imgObj = new Image();
                                // imgObj.src = ret.data.img_url;
                                // //待图片加载完后，将其显示在canvas上

                                var img    = new Image();
                                img.src    = ret.data.img_url;
                                img.onload = function () {
                                    this.width  = _this.w;
                                    this.height = _this.h;
                                    var top     = 0;
                                    var left    = 0;
                                    var img     = new fabric.Image(this, {
                                        left : left,
                                        top  : top,
                                    });
                                    // todo 目前生成的图片还是已以控件的形式添加在画布上的，能否直接将该图片设置为背景。
                                    _this.ctx.clear();
                                    _this.ctx.add(img);
                                    _this.renderOBJ    = null;
                                    _this.renderOption = null;
                                };
                            });
                        } else {
                            $.toast(ret.msg, "forbidden");
                        }
                    }, 'json').error(function (err) {
                        $('#createImg').hide();
                        console.log(err);
                    });
                });
                //canvas点击

                this.ctx.on('mouse:down', function (options, self) {

                });
            },
            initColor    : function () {
                $('input.color').each(function () {
                    $(this).minicolors({
                        defaultValue : '#000'
                    });
                });
            },
            renderBGImg:function(){
                var bg =$('#bg-img');
                var _this =this;
                if(bg.length >0){
                    var img = new Image();
                    img.src = bg.attr('src');
                    img.onload=function(){
                    console.log(bg.length);
                        _this.bg_ctx.drawImage(this,0,0,_this.w,_this.h);
                        var img1  = new fabric.Image(img, {
                            left : 0,
                            top  : 0,
                            width:_this.w,
                            height:_this.h
                        });
                        // _this.grids.add(img1);
                    }
                }
            }
            ,
            createOBJ    : function () {
                var obj = new fabric[this.renderOBJ, this.renderOption];
                this.ctx.add(obj);
            }
            ,
            renderBG     : function () {
                var num    = 10;
                var w      = this.w;
                var space  = w / num;
                var h      = this.h;
                var l_num  = Math.ceil(h / space);
                var option = {
                    fill               : '#ccc',
                    stroke             : '#ccc',
                    opacity            : 0.2,
                    strokeWidth        : 1,
                    hasControls        : false,
                    hasRotatingPoint   : false,
                    hasBorders         : false,
                    transparentCorners : true,
                    perPixelTargetFind : true,
                    selectable         : false,
                    lockMovementX      : true,
                    lockMovementY      : true,
                };
                for (var i = 1; i < l_num; i++) {
                    var line = new fabric.Line([w, i * space, 0, i * space], option);
                    this.ctx.add(line);
                }
                for (var i = 1; i < num; i++) {
                    var line = new fabric.Line([i * space, 0, i * space, h], option);
                    this.ctx.add(line);
                }
            }
            ,
            setHeight    : function () {
                var h  = $('.canvas-wrap').height();
                var w  = $('.canvas-wrap').width();
                this.w = w;
                this.h = h;
                $('canvas').each(function () {
                    $(this)[0].height = h;
                    $(this)[0].width  = w;
                });
            },
            createOption : function (el) {
                var option = {};
                $(el).each(function (i, e) {
                    var keys = $(e).attr('key').split(' ');
                    var val  = $(this).val();
                    $.each(keys, function (i, e) {
                        option[e] = val;
                    });
                });
                return option;
            },
            renderFN     : {
                Line           : function (option) {
                    var line = new fabric.Line([this.w / 3, this.h / 2, this.w * (2 / 3), this.h / 2], option);
                    console.log(this.renderOBJ);
                    console.log(JSON.stringify([this.w / 3, this.h / 2, this.w * (2 / 3), this.h / 2]));
                    this.ctx.add(line);
                },
                isDrawingMode  : function (option) {
                    this.ctx.freeDrawingBrush.color = option.color;
                    this.ctx.freeDrawingBrush.width = option.width;
                    this.ctx.isDrawingMode          = true;
                    $('.btn-hb').show();
                },
                renderTriangle : function (option) {
                    var w         = this.w / 4;
                    var top       = (this.h - w) / 2;
                    var left      = (this.w - w) / 2;
                    option.width  = w;
                    option.height = w;
                    option.top    = top;
                    option.left   = left;
                    var tri       = new fabric.Triangle(option);
                    this.ctx.add(tri);
                },
                renderCircle   : function (option) {
                    var w         = this.w / 5;
                    var top       = (this.h - w * 2) / 2;
                    var left      = (this.w - w * 2) / 2;
                    option.radius = w;
                    option.top    = top;
                    option.left   = left;
                    var tri       = new fabric.Circle(option);
                    this.ctx.add(tri);
                },
                renderEllipse  : function (option) {
                    var w       = this.w / 3;
                    var h       = w * 0.5;
                    var top     = (this.h - h * 2) / 2;
                    var left    = (this.w - w * 2) / 2;
                    option.rx   = w;
                    option.ry   = h;
                    option.top  = top;
                    option.left = left;
                    console.log(JSON.stringify(option));
                    var ell = new fabric.Ellipse(option);
                    this.ctx.add(ell);
                },
                renderArrow    : function (option) {
                    option.strokeWidth = 1;
                    var w              = this.w * 0.3;
                    var l_left         = (this.w - w) / 2;
                    var l_top          = (this.h - option.strokeWidth) * 0.5;
                    console.log(JSON.stringify([l_left, l_top, l_left + w, l_top]));
                    var line  = new fabric.Line([l_left, l_top, l_left + w, l_top], option);
                    var a_w   = w * 0.05;
                    var a_h   = a_w * 2;
                    var arr   = new fabric.Triangle({
                        width  : a_w,
                        height : a_h,
                        left   : l_left + w + 3,
                        top    : (this.h - a_h / 2 - option.strokeWidth / 2 - 0.5) / 2,
                        fill   : option.fill,
                        angle  : 90
                    });
                    var group = new fabric.Group([line, arr], {
                        left : l_left,
                        top  : l_top
                    });

                    this.ctx.add(group);
                }
            }
        };
        obj.init();
    });
</script>