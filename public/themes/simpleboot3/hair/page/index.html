<include file="hair@public/head"/>
<link rel="stylesheet" href="__PAGE_TOOLS__/css/minicolor.css">
<link rel="stylesheet" href="__PAGE_TOOLS__/css/main.css">
<script src="__PAGE_TOOLS__/js/flexible.js"></script>

<form id="page_info">
    <input type="hidden" name="id" value="{$page.id}"/>
    <input type="hidden" name="user_id" value="{$page.user_id}"/>
    <input type="hidden" name="project_id" value="{$page.project_id}"/>
    <input type="hidden" name="name" value="{$page.name}"/>
    <input type="hidden" name="image" value=""/>
</form>
    <div class="wrap">
        <div class="tab">
            <ul>
            <li class="fl"><a href="{:url('hair/project/detail',['id'=>$page.project_id])}">返回</a></li>
            <li class="fl tri-head">头像</li>
            <li class="fl tri-fun">工具</li>
            <li class="fl tri-tool">功能</li>
            <li class="fl tri-word">文字</li>
            <li class="fl">分享</li>
            </ul>
        </div>
        <div class="main-wrap">
            <div class="canvas-wrap">
            <!-- 背景图片 -->
            <img src="__PAGE_TOOLS__/images/bg.png" alt="" id="bg-img" style="position: absolute;width:100%;height: 100%;opacity: 0;z-index: -2;">
                <div class="c-inner">
                    
                <canvas id="canvas-grids"></canvas>
                </div>
                <div class="c-inner">
                    
                <canvas id="canvas-bg"></canvas>
                </div>
                <div class="c-inner">
                    
                <canvas id="canvas"></canvas>
                </div>
            </div>
            <div class="m-tool m-all-tool">
                <div class="m-inner">
                    <ul>
                        <li class="h-icon fl" renderType='renderLigature'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">发片</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='Line' >
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">直线</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderArrow'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">箭头</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderArc'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">弧线箭头</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderDashedArc'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">虚弧线箭头</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderTriangle' >
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">三角形</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderCircle'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">圆形</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='renderEllipse'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">椭圆</p>
                            </div>
                        </li>
                        <li class="h-icon fl" renderType='isDrawingMode'>
                            <div class="h-one">
                                <div class="h-img-wrap">
                                    <img src="__PAGE_TOOLS__/images/bg.png" alt="">
                                </div>
                                <p class="h-text">画笔</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="m-head m-all-tool">
                <div class="m-inner">
                    <ul>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_0.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_1.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_2.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_3.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_4.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_5.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_6.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_7.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/bg_8.png" alt="">
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="m-fun m-all-tool">
                <div class="m-inner">
                    <ul>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/tool_1.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/tool_2.png" alt="">
                            </div>
                        </li>
                        <li class="h-icon fl">
                            <div class="h-one add-ele">
                                <img src="__PAGE_TOOLS__/images/tool_4.png" alt="">
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="mask" id="select-cx">
            <div class="m-box">
                <ul >
                    <li  >
                        <p class="text-c">发片</p>
                        <p>
                            请选择颜色:<input class="s-select color" type="hidden" key='stroke ' >
                        </p>
                    </li>
                    <li >
                        <p class="text-c">直线</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='stroke fill' ></p>
                        <p>线宽：<select class="s-select" key='strokeWidth' id="">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                </select>
                        </p>
                    </li>
                    <li>
                        <p class="text-c">箭头</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='stroke fill' ></p>
                    </li>
                    <li>
                        <p class="text-c">弧线箭头</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='stroke ' ></p>
                    </li>
                    <li>
                        <p class="text-c">虚弧线箭头</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='stroke ' ></p>
                    </li>
                    <li>
                        <p class="text-c">三角形</p>
                        <p>颜色：<input class="s-select color" type="hidden"  key='fill' ></p>
                    </li>
                    <li>
                        <p class="text-c">圆形</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='fill' ></p>
                    </li>
                    <li>
                        <p class="text-c">椭圆</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='fill' ></p>
                    </li>
                    <li>
                        <p class="text-c">画笔</p>
                        <p>颜色：<input class="s-select color" type="hidden" key='color' ></p>
                        <p>线宽：<select class="s-select " key='width' id="">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                </select>
                        </p>
                    </li>
                </ul>
                <div class="btn-wrap">
                    <div class="btn-no">取消</div>
                    <div class="btn-ok add-ele">确定</div>
                </div>
            </div>
        </div>
        <div class="mask" id="text">
            <div class="m-box">
                <div class="text-wrap">
                    <!-- <p>文案：<input type="text" id="i-text"></p> -->
                    <p>文案：<textarea  id="i-text" ></textarea></p>
                    <p>颜色：<input class="text-option color" type="hidden"  key='stroke fill' name='color'></p>
                    <p>粗细：<select class="text-option" key='fontWeight'  id="text-width">
                                <option value="normal">正常</option>
                                <option value="bold">加粗</option>
                            </select>
                    </p>
                    <p>字体：<select class="text-option" key='fontSize' name="" id="font-size">
                                <option value="12">12</option>
                                <option value="14">14</option>
                                <option value="16">16</option>
                                <option value="18">18</option>
                                <option value="20">20</option>
                            </select>
                    </p>
                </div>
                <div class="btn-wrap">
                    <div class="btn-no">取消</div>
                    <div class="btn-ok add-ele">确定</div>
                </div>
            </div>
        </div>
        <div class="footer-btn">
            <div class="btn-pre btn fl" style="display: none;">上一步</div>
            <div class="btn-delete btn fl">删除</div>
            <div class="btn-save fr btn">生成图片</div>
            <div class="btn-hb btn fr">移除画笔</div>
        </div>
    </div>
    <div class="mask" id="createImg">
        <div class="m-box text-c">图片生成中...</div>
    </div>
<include file="hair@public/foot"/>

<script src="__PAGE_TOOLS__/js/jquery.min.js"></script>
<script src="__PAGE_TOOLS__/js/jquery.minicolor.js"></script>
<script src="__PAGE_TOOLS__/js/fabric_gestures.js"></script>
<script>
    $(function(){
        window.obj={
            init:function(){
                var _this = this;
                this.controllerCircleArr=[];
                this.bg_cache=[];
                this.offsetX = $('.main-wrap').offset().left;
                this.offsetY = $('.main-wrap').offset().top;
                this.renderOBJ = null;
                this.renderOption=null;
                this.canvas = $('#canvas');
                this.canvas_bg=$('#canvas-bg');
                this.bg_ctx = this.canvas_bg[0].getContext("2d");
                this.setHeight();
                this.grids = new fabric.Canvas('canvas-grids');
                this.ctx =new fabric.Canvas('canvas');
                this.ctx.isDrawingMode =false;
                this.baseSize = this.w/5;
                this.initColor();
                this.bindEvent();
                this.renderBG();
            },
            bindEvent:function(){
                var _this =this;
                $('.add-ele').on('click',function(){
                    _this.bg_add();
                });
                //工具头像切换
                $('.tri-head').on('click',function(){
                    $('.m-head').slideToggle();
                    $('.m-tool').hide();
                    $('.m-fun').hide();

                });
                $('.tri-tool').on('click',function(){
                    $('.m-tool').slideToggle();
                    $('.m-head').hide();
                    $('.m-fun').hide();
                });
                $('.tri-fun').on('click',function(){
                    $('.m-fun').slideToggle();
                    $('.m-head').hide();
                    $('.m-tool').hide();
                });
                //头像点击
                $('.m-head .h-one,.m-fun .h-one').on('click',function(){
                   var src = $(this).find('img').attr('src');
                   var img1 = $(this).find('img')[0];
                   var img = new Image();
                   img.src=src;
                   var width = parseFloat($(img1).css('width'));
                   var height = parseFloat($(img1).css('height'));
                   var i_w=_this.w*(2/5);
                   var i_h=height/width*i_w;
                   var top = (_this.h-i_h)*0.6;
                   var left = (_this.w-i_w)/2;
                   img.onload=function(){
                       var img = new fabric.Image(this,{
                        left:left,
                        top:top,
                       });
                       img.width=i_w;
                       img.height=i_h;
                       _this.ctx.add(img);
                   }
                   $(this).parents('.m-all-tool').slideUp();
                });
                //工具点击
                $('.m-tool li.h-icon').on('click',function(){
                   var index = $(this).index(); 
                    _this.renderOBJ =$(this).attr('renderType');
                   $('#select-cx').show().find('li').eq(index).addClass('on').siblings().removeClass('on');
                });
                $('#select-cx .btn-wrap .btn-ok').on("click",function(){
                    var obj={};
                    var hasOption = false;
                    var option = $('#select-cx ul li.on').find('.s-select');
                    option = _this.createOption(option);
                    console.log(JSON.stringify(option));
                    console.log(_this.renderOBJ);
                    _this.renderFN[_this.renderOBJ].call(_this,option);
                    $('#select-cx').hide();
                    $('.m-tool').hide();
                });
                $('.btn-wrap .btn-no').on("click",function(){
                    $('#select-cx input').val('');
                    $(this).parents('.mask').hide();
                    _this.renderOBJ=null;
                    _this.renderOption=null;
                });
                //文案点击
                //
                $('.tri-word').on('click',function(){
                   $('.m-all-tool').hide();
                   $('#text').show(); 
                });
                $('#text .btn-ok').on('click',function(){
                    var text = $('#i-text').val();
                    if(text ==''){
                        alert('文案不能为空~');
                        return false;
                    }
                    var input_option = $('#text').find('.text-option');
                    var option = _this.createOption(input_option);
                    console.log(JSON.stringify(option));
                    option.left = _this.w/2;
                    option.top = _this.h/2;
                    option.textAlign = 'center';
                    option.width =_this.w/2;
                    // option.originY='top';
                    _this.renderOBJ = 'Text';
                    var text_obj = new fabric[_this.renderOBJ](text,option);
                    console.log(text_obj.width);
                    _this.ctx.add(text_obj);
                    $(this).parents('.mask').hide();
                    $('#i-text').val('');
                    $('.m-all-tool').hide();
                    _this.renderOBJ=null;
                    _this.renderOption=null;

                });
                    //
                    //
                    //画笔
                $('.btn-hb').on('click',function(){
                   $(this).hide(); 
                   _this.ctx.isDrawingMode=false;
                });

                ///生成图片
                $('.btn-save').on('click', function () {
                    var png = _this.ctx.toDataURL();
                    $('#createImg').show();
                    $("#page_info input[name='image']").val(png);
                    var form = $('#page_info');
                    $.post("{:url('hair/page/doSavePage')}", form.serializeArray(), function (ret) {
                        $('#createImg').hide();
                        if (ret.code) {
                            $.toast(ret.msg, 'success', function () {
                                // window.location.href = ret.data.from_url;
                                // var imgObj = new Image();
                                // imgObj.src = ret.data.img_url;
                                // //待图片加载完后，将其显示在canvas上

                                    var img    = new Image();
                                    img.src    = ret.data.img_url;
                                    img.onload = function () {
                                        this.width  = _this.w;
                                        this.height = _this.h;
                                        var top     = 0;
                                        var left    = 0;
                                        var img     = new fabric.Image(this, {
                                            left : left,
                                            top  : top,
                                        });
                                    // todo 目前生成的图片还是已以控件的形式添加在画布上的，能否直接将该图片设置为背景。
                                    _this.ctx.clear();
                                    // _this.ctx.add(img);
                                    _this.renderOBJ    = null;
                                    _this.renderOption = null;
                                };
                            });
                        } else {
                            $.toast(ret.msg, "forbidden");
                        }
                    }, 'json').error(function (err) {
                        $('#createImg').hide();
                        console.log(err);
                    });
                });
                //canvas点击
                
                // this.ctx.on('mouse:down',function(options,self){
                    
                // });
                $('.btn-pre').on('click',function(){
                   _this.pre(); 
                });
            },
            renderBGImg:function(){
                var bg =$('#bg-img');
                var _this =this;
                if(bg.length >0){
                    var img = new Image();
                    img.src = bg.attr('src');
                    img.onload=function(){
                    console.log(bg.length);
                        _this.bg_ctx.drawImage(this,0,0,_this.w,_this.h);
                        // img.width = _this.w;
                        // img.height =_this.h;
                        // var img1  = new fabric.Image(img, {
                        //     left : 0,
                        //     top  : 0,
                        //     width:_this.w,
                        //     height:_this.h
                        // });
                        // _this.grids.add(img1);
                    }
                }
            }
            ,
            initColor:function(){
                $('input.color').each(function(){
                    $(this).val('#000');
                   $(this).minicolors({
                        defaultValue:'#000'
                   }); 
                });
            },
            pre:function(){
                if(this.ctx.getObjects().length>0){
                    this.ctx.clear();
                    return false;
                }
                this.bg_cache.pop();
                this.renderBgArr();
                if(this.bg_cache.length<=0){
                    $('.btn-pre').hide();
                }
            }
            ,
            bg_add:function(){

                if(this.ctx.getObjects().length<=0){return false;};
                $('.btn-pre').show();
                var _this = this;
                var currentObj =obj.ctx.getActiveObject();
               if(currentObj){
                    currentObj.set({
                        borderColor:'transparent',
                        cornerColor:'transparent'
                    })
               }
               for(var i=0;i<this.controllerCircleArr.length;i++){
                this.controllerCircleArr[i].set({opacity:0});
               }
               var bg= this.ctx.toDataURL();
               this.bg_cache.push(bg);
               this.renderBgArr();
               this.ctx.clear();
                fabric.Object.prototype.originX ='left'; 
                fabric.Object.prototype.originY = 'top';
            },
            renderBgArr:function(){
               this.bg_ctx.clearRect(0,0,this.w,this.h);
                var _this =this;
               for(var i=0;i<this.bg_cache.length;i++){
                (function(i){
                    var img = new Image();
                   img.src=_this.bg_cache[i];
                   img.onload=function(){
                        _this.bg_ctx.drawImage(img,0,0,_this.w,_this.h);
                        }
                })(i);
               }
            }
            ,
            createOBJ:function(){
                var obj = new fabric[this.renderOBJ,this.renderOption];
                this.ctx.add(obj);
            }
            ,
            renderBG:function(){
                var num =10;
                var w = this.w;
                var space = w/num;
                var h = this.h;
                var l_num = Math.ceil(h/space);
                var option = {
                          fill: '#ccc',
                          stroke: '#ccc',
                          opacity:0.2,
                          strokeWidth: 1,
                          hasControls: false, 
                          hasRotatingPoint: false,
                          hasBorders:false,
                          transparentCorners:true,
                          perPixelTargetFind:true,
                          selectable:false,
                          lockMovementX: true,
                          lockMovementY: true,
                    };
                for(var i = 1;i<l_num;i++){
                    var line = new fabric.Line([w,i*space,0,i*space],option);
                    this.grids.add(line);
                }
                for(var i = 1;i<num;i++){
                    var line = new fabric.Line([i*space,0,i*space,h],option);
                    this.grids.add(line);
                }
            }
            ,
            setHeight:function(){
                var h = $('.canvas-wrap').height();
                var w = $('.canvas-wrap').width();
                this.w=w;
                this.h=h;
                $('canvas').each(function(){
                   $(this)[0].height=h; 
                   $(this)[0].width=w; 
                });
            },
            angle:function (start,end){
                var px=start.x;
                var py = start.y;
                var mx=end.x;
                var my=end.y;
                var x = Math.abs(px-mx);
                var y = Math.abs(py-my);
                var z = Math.sqrt(Math.pow(x,2)+Math.pow(y,2));
                var cos = y/z;
                var radina = Math.acos(cos);
                var angle = Math.floor(180/(Math.PI/radina));
                if(mx>px&&my>py){
                    angle = 180 - angle;
                }
                if(mx==px&&my>py){
                    angle = 180;
                }
                if(mx>px&&my==py){
                    angle = 90;
                }
                if(mx<px&&my>py){
                    angle = 180+angle;
                }
                if(mx<px&&my==py){
                    angle = 270;
                }
                if(mx<px&&my<py){
                    angle = 360 - angle;
                }
                return angle;
            },
            createOption:function(el){
                var option={};
                $(el).each(function(i,e){
                    var keys = $(e).attr('key').split(' ');
                    var val = $(this).val();
                    $.each(keys,function(i,e){
                        option[e]=val;
                    });
                });
                return option;
            },
            renderFN:{
                Line:function(option){
                  var line = new fabric.Line([this.w/3,this.h/2,this.w*(2/3),this.h/2],option);
                    console.log(this.renderOBJ);
                    console.log(JSON.stringify([this.w/3,this.h/2,this.w*(2/3),this.h/2]));
                  this.ctx.add(line);
                },
                isDrawingMode:function(option){
                    this.ctx.freeDrawingBrush.color =option.color;
                    this.ctx.freeDrawingBrush.width  =option.width;
                    this.ctx.isDrawingMode =true;
                    $('.btn-hb').show();
                },
                renderTriangle:function(option){
                    var w = this.w/4;
                    var top = (this.h-w)/2;
                    var left =(this.w-w)/2;
                    option.width = w; 
                    option.height = w; 
                    option.top =top; 
                    option.left = left; 
                    var tri = new fabric.Triangle(option);
                    this.ctx.add(tri);
                },
                renderCircle:function(option){
                    var w = this.w/5;
                    var top = (this.h-w*2)/2;
                    var left =(this.w-w*2)/2;
                    option.radius = w; 
                    option.top =top; 
                    option.left = left; 
                    var tri = new fabric.Circle(option);
                    this.ctx.add(tri);
                },
                renderEllipse:function(option){
                    var w = this.w/3;
                    var h = w*0.5;
                    var top = (this.h-h*2)/2;
                    var left =(this.w-w*2)/2;
                    option.rx =w;
                    option.ry =h;
                    option.top =top; 
                    option.left = left; 
                    console.log(JSON.stringify(option));
                    var ell = new fabric.Ellipse(option);
                    this.ctx.add(ell);
                }
                ,
                renderArrow:function(option){
                    option.strokeWidth=1;
                    var w = this.w*0.3;
                    var l_left = (this.w-w)/2;
                    var l_top = (this.h-option.strokeWidth)*0.5;
                    console.log(JSON.stringify([l_left,l_top,l_left+w,l_top]));
                    var line = new fabric.Line([l_left,l_top,l_left+w,l_top],option);
                    var a_w=w*0.05;
                    var a_h=a_w*2;
                    var arr = new fabric.Triangle({
                        width:a_w,
                        height:a_h,
                        left:l_left+w+3,
                        top:(this.h-a_h/2-option.strokeWidth/2-0.5)/2,
                        fill:option.fill,
                        angle:90
                    });
                    var group = new fabric.Group([line,arr],{
                        left:l_left,
                        top:l_top
                    });
                    
                    this.ctx.add(group);
                },
                renderArc:function(option,isTrue){
                    var _this =this;
                    var canvas = this.ctx;
                    fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
                    option.objectCaching=false;
                    option.fill='';
                    option.strokeWidth=2;
                    if(isTrue){
                        option.strokeDashArray=[6,6];
                    }
                  canvas.on({
                    'object:moving': onObjectMoving,
                  });

                    var pointArr=[
                        [_this.w*(1/3),_this.h/2-50],
                        [_this.w*(1/2),_this.h/2+50],
                        [_this.w*(2/3),_this.h/2-50]
                    ];
                    // var line = new fabric.Path('M 65 0 Q 100, 100, 200, 0', option);
                    var line = new fabric.Path('M 65 0 Q 100, 100, 200, 0', option);

                    line.path[0][1] = pointArr[0][0];
                    line.path[0][2] = pointArr[0][1];

                    line.path[1][1] = pointArr[1][0];
                    line.path[1][2] = pointArr[1][1];

                    line.path[1][3] = pointArr[2][0];
                    line.path[1][4] = pointArr[2][1];
                    line.name='arcLine';
                    line.selectable = false;
                    canvas.add(line);

                    var a_w =10;
                    var a_h=a_w*2;
                    var arr_angle=_this.angle({x:pointArr[1][0],y:pointArr[1][1]},{x:pointArr[2][0],y:pointArr[2][1]});
                    var arr = new fabric.Triangle({
                        width:a_w,
                        height:a_h,
                        left:pointArr[2][0],
                        top:pointArr[2][1],
                        fill:option.stroke,
                        angle:arr_angle
                    });
                    arr.selectable = false;
                    canvas.add(arr);

                    var p1 = makeCurvePoint(pointArr[1][0], pointArr[1][1], null, line, null,arr)
                    p1.name = "p1";
                    p1.pointArr=pointArr;
                    p1.arr=arr;
                    canvas.add(p1);

                    var p0 = makeCurveCircle(pointArr[0][0], pointArr[0][1], line, p1, null,null);
                    p0.name = "p0";
                    canvas.add(p0);

                    var p2 = makeCurveCircle(pointArr[2][0], pointArr[2][1], null, p1, line,arr);
                    p2.name = "p2";
                    p2.pointArr=pointArr;
                    p2.arr=arr;
                    canvas.add(p2);

                    

                  function makeCurveCircle(left, top, line1, line2, line3,arr ) {
                    var c = new fabric.Circle({
                      left: left,
                      top: top,
                      strokeWidth: 5,
                      radius: 12,
                      fill: 'transparent',
                      // fill: '#fff',
                      stroke: '#666',
                    });

                    c.hasBorders = c.hasControls = false;

                    c.line1 = line1;
                    c.line2 = line2;
                    c.line3 = line3;
                    c.arr=arr;
                    _this.controllerCircleArr.push(c);
                    return c;
                  }

                  function makeCurvePoint(left, top, line1, line2, line3) {
                    var c = new fabric.Circle({
                      left: left,
                      top: top,
                      strokeWidth: 8,
                      radius: 14,
                      fill: 'transparent',
                      // fill: '#fff',
                      stroke: '#666'
                    });

                    c.hasBorders = c.hasControls = false;

                    c.line1 = line1;
                    c.line2 = line2;
                    c.line3 = line3;
                    _this.controllerCircleArr.push(c);
                    return c;
                  }
                  function onObjectMoving(e) {
                    if (e.target.name == "p0" || e.target.name == "p2") {
                      var p = e.target;

                      if (p.line1) {
                        p.line1.path[0][1] = p.left;
                        p.line1.path[0][2] = p.top;
                        p.line1.path
                      }
                      else if (p.line3) {
                        p.line3.path[1][3] = p.left;
                        p.line3.path[1][4] = p.top;
                      }
                    }
                    else if (e.target.name == "p1") {
                      var p = e.target;

                      if (p.line2) {
                        p.line2.path[1][1] = p.left;
                        p.line2.path[1][2] = p.top;
                      }
                    }
                    else if (e.target.name == "p0" || e.target.name == "p2") {
                      var p = e.target;

                      p.line1 && p.line1.set({ 'x2': p.left, 'y2': p.top });
                      p.line2 && p.line2.set({ 'x1': p.left, 'y1': p.top });
                      p.line3 && p.line3.set({ 'x1': p.left, 'y1': p.top });
                      p.line4 && p.line4.set({ 'x1': p.left, 'y1': p.top });
                    }

                    if(e.target.name =='p1' &&e.target.pointArr){
                        pointArr[1][0]=p.left;
                        pointArr[1][1]=p.top;
                    }
                    if(e.target.name =='p2' &&e.target.pointArr){
                        pointArr[2][0]=p.left;
                        pointArr[2][1]=p.top;
                    }
                    var arr_angle=_this.angle({x:pointArr[1][0],y:pointArr[1][1]},{x:pointArr[2][0],y:pointArr[2][1]});
                    arr.set({
                        left:pointArr[2][0],
                        top:pointArr[2][1],
                        angle:arr_angle
                    })
                  }
                },
                renderDashedArc:function(option){
                    this.renderFN.renderArc.call(obj,option,true);
                }
                ,
                renderLigature:function(option){
                    var canvas = this.ctx;
                    fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
                    var _this =this;
                    option.strokeLineCap='square';
                    function makeCircle(left, top, line1, line2) {
                            var c = new fabric.Circle({
                              left: left,
                              top: top,
                              strokeWidth: 5,
                              radius: 12,
                              fill: 'transparent',
                              stroke: '#666',
                            });
                            c.hasControls = c.hasBorders = false;

                            c.line1 = line1;
                            c.line2 = line2;
                            _this.controllerCircleArr.push(c);
                            return c;
                  };
                  var lineArr=[
                    [this.w*(1/3),this.h/2+50,this.w*(1/3),this.h/2-50],
                    [this.w*(1/3),this.h/2-50,this.w*(2/3),this.h/2-50],
                    [this.w*(2/3),this.h/2-50,this.w*(2/3),this.h/2+50]
                  ];
                  function makeLine(coords) {
                    return new fabric.Line(coords, {
                      fill: option.stroke,
                      stroke: option.stroke,
                      strokeWidth: 2,
                      selectable: false
                    });
                  }

                  var line = makeLine(lineArr[0]),
                      line2 = makeLine(lineArr[1]),
                      line3 = makeLine(lineArr[2]);

                  canvas.add(line, line2, line3);

                  canvas.add(
                    makeCircle(line.get('x1'), line.get('y1'), line),
                    makeCircle(line.get('x2'), line.get('y2'), line2, line),
                    makeCircle(line2.get('x2'), line2.get('y2'), line3,line2),
                    makeCircle(line3.get('x2'), line3.get('y2'), null,line3)
                  );

                  canvas.on('object:moving', function(e) {
                    var p = e.target;
                    p.line1 && p.line1.set({ 'x1': p.left, 'y1': p.top });
                    p.line2 && p.line2.set({ 'x2': p.left, 'y2': p.top });
                    canvas.renderAll();
                  });
                }
            }
        };
        obj.init();
    });
</script>